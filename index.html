<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Flag War - Auto-Pause</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #020617; font-family: sans-serif; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #counter { position: absolute; top: 15px; left: 15px; font-size: 18px; font-weight: 900; color: #22d3ee; text-shadow: 2px 2px 4px #000; }
        
        #winner-box {
            display: none; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; padding: 25px; border-radius: 20px; border: 6px solid #fbbf24;
            text-align: center; box-shadow: 0 0 50px #22d3ee; z-index: 100; pointer-events: auto;
            width: 70%; max-width: 260px;
        }
        #winner-flag { width: 110px; height: 75px; border: 2px solid #333; margin: 15px 0; }
        #winner-name { font-size: 24px; font-weight: 900; color: #0f172a; display: block; }
        
        #start-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 26px; padding: 15px 50px; background: #22d3ee; color: #020617;
            border: none; border-radius: 50px; cursor: pointer; pointer-events: auto; font-weight: bold;
            box-shadow: 0 0 20px #22d3ee;
        }
        .retry { margin-top: 15px; padding: 10px 20px; background: #333; color: white; border: none; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>

<audio id="bgMusic" src="15-yanvar 2026.mp3" loop preload="auto"></audio>

<div id="ui">
    <div id="counter">Davlatlar: 0</div>
    <div id="winner-box">
        <h2 style="margin:0">G'OLIB!</h2>
        <img id="winner-flag" src="">
        <span id="winner-name"></span>
        <button class="retry" onclick="location.reload()">QAYTA O'YNASH</button>
    </div>
</div>

<button id="start-btn" onclick="startGame()">BOSHLASH</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

<script>
    const { Engine, Render, Runner, Bodies, Composite, Events, Body, Vector } = Matter;

    const bgMusic = document.getElementById("bgMusic");
    bgMusic.volume = 0.8;
    let musicStarted = false;

    // --- ASOSIY QISM: O'YINDAN CHIQSA MUSIQANI O'CHIRISH ---
    document.addEventListener("visibilitychange", function() {
        if (document.hidden) {
            // Agar foydalanuvchi tabni almashtirsa yoki o'yindan chiqsa
            bgMusic.pause();
        } else {
            // Agar foydalanuvchi qaytib kirsa va o'yin boshlangan bo'lsa
            if (musicStarted) {
                bgMusic.play().catch(e => console.log("Avto-play xatosi"));
            }
        }
    });

    const CONFIG = {
        ringRadius: 145,       
        ballSize: 8,           
        targetSpeed: 2.8,      
        rotationSpeed: 0.009,  
        gravityValue: 0.8      
    };

    const countries = [
        {name:"O'zbekiston",code:"uz"},{name:"AQSH",code:"us"},{name:"Rossiya",code:"ru"},{name:"Xitoy",code:"cn"},
        {name:"Turkiya",code:"tr"},{name:"Germaniya",code:"de"},{name:"Yaponiya",code:"jp"},{name:"Fransiya",code:"fr"},
        {name:"Koreya",code:"kr"},{name:"Hindiston",code:"in"},{name:"Angliya",code:"gb"},{name:"Braziliya",code:"br"},
        {name:"Qozog'iston",code:"kz"},{name:"Qirg'iziston",code:"kg"},{name:"Tojikiston",code:"tj"},{name:"Turkmaniston",code:"tm"},
        {name:"Ozarbayjon",code:"az"},{name:"Afg'oniston",code:"af"},{name:"Eron",code:"ir"},{name:"Pokiston",code:"pk"},
        {name:"Saudiya Arabistoni",code:"sa"},{name:"BAA",code:"ae"},{name:"Misr",code:"eg"},{name:"Ispaniya",code:"es"},
        {name:"Italiya",code:"it"},{name:"Portugaliya",code:"pt"},{name:"Argentina",code:"ar"},{name:"Kanada",code:"ca"},
        {name:"Meksika",code:"mx"},{name:"Avstraliya",code:"au"},{name:"Ukraina",code:"ua"},{name:"Polsha",code:"pl"},
        {name:"Niderlandiya",code:"nl"},{name:"Shvetsiya",code:"se"},{name:"Norvegiya",code:"no"},{name:"Shveysariya",code:"ch"},
        {name:"Belgiya",code:"be"},{name:"Avstriya",code:"at"},{name:"Gretsiya",code:"gr"},{name:"Armaniston",code:"am"},
        {name:"Gruziya",code:"ge"},{name:"Iroq",code:"iq"},{name:"Isroil",code:"il"},{name:"Indoneziya",code:"id"},
        {name:"Malayziya",code:"my"},{name:"Tailand",code:"th"},{name:"Vyetnam",code:"vn"},{name:"Filippin",code:"ph"},
        {name:"JAR",code:"za"},{name:"Nigeriya",code:"ng"},{name:"Marokash",code:"ma"},{name:"Jazoir",code:"dz"},
        {name:"Chili",code:"cl"},{name:"Kolumbiya",code:"co"},{name:"Peru",code:"pe"},{name:"Urugvay",code:"uy"},
        {name:"Vengriya",code:"hu"},{name:"Chexiya",code:"cz"},{name:"Ruminiya",code:"ro"},{name:"Bolgariya",code:"bg"},
        {name:"Xorvatiya",code:"hr"},{name:"Serbiya",code:"rs"},{name:"Slovakiya",code:"sk"},{name:"Finlyandiya",code:"fi"},
        {name:"Daniya",code:"dk"},{name:"Irlandiya",code:"ie"},{name:"Yangi Zelandiya",code:"nz"},{name:"Singapur",code:"sg"},
        {name:"Qatar",code:"qa"},{name:"Quvayt",code:"kw"},{name:"Ummon",code:"om"},{name:"Iordaniya",code:"jo"},
        {name:"Livan",code:"lb"},{name:"Suriya",code:"sy"},{name:"Falastin",code:"ps"},{name:"Yaman",code:"ye"},
        {name:"Liviya",code:"ly"},{name:"Tunis",code:"tn"},{name:"Efiopiya",code:"et"},{name:"Keniya",code:"ke"},
        {name:"Gana",code:"gh"},{name:"Kuba",code:"cu"},{name:"Yamayka",code:"jm"},{name:"Islandiya",code:"is"},
        {name:"Mo'g'uliston",code:"mn"},{name:"Nepal",code:"np"},{name:"Shri-Lanka",code:"lk"},{name:"Bangladesh",code:"bd"}
    ];

    let engine, render, runner, wheel;
    let balls = [];
    let isPlaying = false;

    function startGame() {
        bgMusic.play().then(() => {
            console.log("Musiqa boshlandi");
            musicStarted = true;
        }).catch(err => {
            console.log("Musiqa yuklanmadi", err);
        });

        document.getElementById('start-btn').style.display = 'none';
        init();
        isPlaying = true;
    }

    function init() {
        engine = Engine.create();
        engine.gravity.y = CONFIG.gravityValue;

        render = Render.create({
            element: document.body,
            engine: engine,
            options: { width: window.innerWidth, height: window.innerHeight, wireframes: false, background: '#020617' }
        });

        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2 - 50;

        const floor = Bodies.rectangle(cx, window.innerHeight - 10, window.innerWidth, 20, { isStatic: true, render: { fillStyle: '#1e293b' } });
        Composite.add(engine.world, [floor]);

        wheel = Composite.create();
        const segments = 65; 
        const gapSize = 9;
        for (let i = 0; i < segments - gapSize; i++) {
            const angle = (i / segments) * Math.PI * 2;
            const wall = Bodies.rectangle(
                cx + Math.cos(angle) * CONFIG.ringRadius,
                cy + Math.sin(angle) * CONFIG.ringRadius,
                25, 4, {
                    isStatic: true,
                    angle: angle + Math.PI / 2,
                    render: { fillStyle: '#22d3ee' },
                    restitution: 1
                }
            );
            Composite.add(wheel, wall);
        }
        Composite.add(engine.world, wheel);

        countries.forEach(c => {
            const ball = Bodies.circle(cx + (Math.random()-0.5)*150, cy + (Math.random()-0.5)*150, CONFIG.ballSize, {
                restitution: 1, friction: 0.1, frictionAir: 0, inertia: Infinity,
                render: {
                    sprite: {
                        texture: `https://flagcdn.com/w80/${c.code}.png`,
                        xScale: (CONFIG.ballSize * 2.3) / 80,
                        yScale: (CONFIG.ballSize * 2.3) / 60
                    }
                },
                label: c.name
            });
            ball.countryCode = c.code;
            ball.isActive = true;
            const angle = Math.random() * Math.PI * 2;
            Body.setVelocity(ball, { x: Math.cos(angle) * CONFIG.targetSpeed, y: Math.sin(angle) * CONFIG.targetSpeed });
            balls.push(ball);
        });
        Composite.add(engine.world, balls);

        Events.on(engine, 'beforeUpdate', () => {
            if (!isPlaying) return;

            Composite.rotate(wheel, CONFIG.rotationSpeed, { x: cx, y: cy });

            balls.forEach(ball => {
                if (ball.isActive) {
                    Body.applyForce(ball, ball.position, { x: 0, y: -engine.gravity.y * engine.gravity.scale * ball.mass });
                    const vel = ball.velocity;
                    const speed = Math.sqrt(vel.x * vel.x + vel.y * vel.y);
                    if (speed !== 0) {
                        Body.setVelocity(ball, { x: (vel.x / speed) * CONFIG.targetSpeed, y: (vel.y / speed) * CONFIG.targetSpeed });
                    }

                    const dist = Vector.magnitude(Vector.sub(ball.position, {x: cx, y: cy}));
                    if (dist > CONFIG.ringRadius + 15) {
                        ball.isActive = false;
                        ball.frictionAir = 0.02;
                    }
                }
            });

            const aliveCount = balls.filter(b => b.isActive).length;
            document.getElementById('counter').innerText = "Tiriklar: " + aliveCount;

            if (aliveCount === 1 && isPlaying) {
                const winner = balls.find(b => b.isActive);
                if (winner) showWinner(winner);
            }
        });

        Render.run(render);
        Runner.run(Runner.create(), engine);
    }

    function showWinner(b) {
        isPlaying = false;
        document.getElementById('winner-box').style.display = 'block';
        document.getElementById('winner-name').innerText = b.label;
        document.getElementById('winner-flag').src = `https://flagcdn.com/w160/${b.countryCode}.png`;
        // G'olib aniqlanganda musiqa sekinlashib to'xtashini xohlasangiz bgMusic.pause() qo'shish mumkin
    }
</script>
</body>
</html>
